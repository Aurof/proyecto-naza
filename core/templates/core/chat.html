{% load static %}
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Naza Bot - Chat</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/chat.css' %}?v=43">
    <link rel="stylesheet" href="{% static 'css/sound_wave.css' %}">
</head>

<body>
    <!-- Mobile Menu Overlay -->
    <div id="sidebar-overlay" onclick="toggleSidebar()"></div>

    <!-- Mobile Hamburger Button -->
    <button id="mobile-menu-btn" onclick="toggleSidebar()" style="display:none;">
        <span class="material-icons">menu</span>
    </button>

    <aside class="sidebar">
        <div class="logo-area">
            <img src="{% static 'img/naza_logo_v2.png' %}" class="logo-mini">
            <span>Naza Bot</span>
        </div>
        <a href="{% url 'quiz_dashboard' %}" class="learning-hub-btn"
            style="background: linear-gradient(135deg, #03DAC6 0%, #018786 100%); color: #000; padding: 12px; border-radius: 50px; font-weight: 600; font-size: 0.9rem; display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 14px; text-decoration: none; width: 100%; box-sizing: border-box; box-shadow: 0 2px 8px rgba(3,218,198,0.35); transition: all 0.3s ease;">
            <span class="material-icons" style="font-size: 1.1rem;">school</span> Centro de Aprendizaje
        </a>
        <button class="new-chat-btn">
            <span class="material-icons">add</span> Nueva Sesi贸n
        </button>
        <div class="history-list" id="history-box">
            {% if chats %}
            {% for chat in chats %}
            <div class="history-item" id="chat-item-{{ chat.id_conversacion }}"
                onclick="cargarConversacion({{ chat.id_conversacion }})">

                <span class="chat-title-text">{{ chat.titulo }}</span>

                <button class="delete-chat-btn" onclick="deleteChat(event, {{ chat.id_conversacion }})"
                    title="Eliminar chat">
                    <span class="material-icons" style="font-size: 1.1rem;">delete</span>
                </button>

            </div>
            {% endfor %}
            {% else %}
            <p style="padding:10px; color:#666; font-size:0.8rem;">No hay conversaciones a煤n.</p>
            {% endif %}
        </div>
        <div class="user-footer" id="user-menu-trigger" style="cursor: pointer;">
            <div style="display: flex; align-items: center; gap: 8px;">
                <div class="avatar"
                    style="width: 30px; height: 30px; font-size: 1rem; background: #BB86FC; color: black;">
                    {{ request.user.username|slice:":1" }}
                </div>
                <div style="display: flex; flex-direction: column;">
                    <span style="font-weight: bold; font-size: 0.9rem;">{{ request.user.username }}</span>
                    <span style="font-size: 0.7rem; color: #888;">En l铆nea</span>
                </div>
            </div>
            <span class="material-icons" style="color: #888;">expand_less</span>
        </div>

        <div class="user-menu-popup" id="user-menu-popup">
            <!-- (Contenido del men煤 de usuario sin cambios...) -->
            <div id="view-main" class="submenu-view active">
                <div class="menu-header">
                    <div style="display: flex; align-items: center; gap: 15px; width: 100%;">
                        <div class="avatar"
                            style="width: 35px; height: 35px; background: var(--accent); color: white; display:flex; align-items:center; justify-content:center; border-radius:50%; font-weight:bold;">
                            {{ request.user.username|slice:":1"|upper }}
                        </div>
                        <div>
                            <h3>{{ request.user.first_name }}</h3>
                            <p>{{ request.user.email }}</p>
                        </div>
                    </div>
                </div>



                <div class="menu-body">
                    {% if user.is_superuser %}
                    <a href="{% url 'admin_dashboard' %}" class="menu-btn" style="text-decoration: none;">
                        <span class="material-icons" style="color: var(--secondary);">dashboard</span> Panel Admin
                    </a>
                    {% endif %}

                    <a href="{% url 'historial_errores' %}" class="menu-btn" style="text-decoration: none;">
                        <span class="material-icons">history_edu</span> Historial de Errores
                    </a>



                    <a href="{% url 'perfil' %}" class="menu-btn" style="text-decoration: none;">
                        <span class="material-icons" style="color: #BB86FC;">settings</span> Configurar Idiomas & Perfil
                    </a>

                    <button class="menu-btn" onclick="startTutorial()">
                        <span class="material-icons">help_outline</span> Ver Tutorial
                    </button>
                    <button class="menu-btn" onclick="openScenarioHub()" id="scenario-selector-menu-btn">
                        <span class="material-icons" style="color: #03DAC6;">theater_comedy</span>
                        <span id="current-scenario-text">Conversaci贸n Libre</span>
                    </button>
                    <button class="menu-btn" onclick="openGameHub()">
                        <span class="material-icons" style="color: #FFD700;">emoji_events</span> Gamificaci贸n y Stats
                    </button>
                    <div style="height: 1px; background: #3c4043; margin: 8px 0;"></div>
                    <!-- THEME TOGGLE -->
                    <button class="menu-btn" id="theme-btn">
                        <span class="material-icons" id="theme-icon">dark_mode</span>
                        <span id="theme-text">Modo Oscuro</span>
                    </button>

                    <div style="height: 1px; background: #3c4043; margin: 8px 0;"></div>
                    <a href="{% url 'logout' %}" class="menu-btn logout">
                        <span class="material-icons">logout</span> Cerrar Sesi贸n
                    </a>
                </div>
            </div>


        </div>

    </aside>

    <main class="orb-container">

        <div class="gamification-bar" id="gamification-bar" onclick="openGameHub()"
            style="cursor: pointer; transition: transform 0.2s; {% if not progreso.mostrar_gamificacion %}display:none;{% else %}display:flex;{% endif %}">
            <div class="stat-pill" title="Nivel Actual">
                <span class="material-icons pill-icon">military_tech</span>
                <span id="stat-level">Nvl {{ progreso.nivel }}</span>
            </div>
            <div class="stat-pill" title="Experiencia">
                <span class="material-icons pill-icon">bolt</span>
                <span id="stat-xp">{{ progreso.experiencia }} XP</span>
            </div>
            <div class="stat-pill" title="Racha de D铆as">
                <span class="material-icons pill-icon">local_fire_department</span>
                <span id="stat-streak">{{ progreso.racha_actual }}</span>
            </div>
        </div>

        <div class="scenario-selector" id="scenario-selector-btn" onclick="openScenarioHub()">
            <span class="material-icons" id="current-scenario-icon">chat</span>
            <span id="current-scenario-text">Conversaci贸n Libre</span>
            <span class="material-icons" style="font-size: 1rem; opacity: 0.5;">expand_more</span>
        </div>

        <div id="scenario-hub-overlay" class="game-hub-overlay">
            <div class="game-hub-card" style="width: 600px;">
                <button class="btn-close-hub" onclick="closeScenarioHub()">&times;</button>
                <div class="hub-header">
                    <h2>Elige un Escenario</h2>
                    <p style="color:#888;">Naza actuar谩 un rol para que practiques situaciones reales.</p>
                </div>
                <div class="hub-content" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">

                    <div class="role-card active"
                        onclick="selectScenario('general', 'chat', 'Conversaci贸n Libre', this)">
                        <span class="material-icons" style="color: #BB86FC;">chat</span>
                        <div>
                            <strong>Libre</strong>
                            <small>Tu amigo tutor normal.</small>
                        </div>
                    </div>

                    <div class="role-card" onclick="selectScenario('cafe', 'local_cafe', 'Pedir un Caf茅', this)">
                        <span class="material-icons" style="color: #FF9800;">local_cafe</span>
                        <div>
                            <strong>Cafeter铆a</strong>
                            <small>Mesero en Londres.</small>
                        </div>
                    </div>

                    <div class="role-card" onclick="selectScenario('airport', 'flight_land', 'Inmigraci贸n', this)">
                        <span class="material-icons" style="color: #03DAC6;">flight_land</span>
                        <div>
                            <strong>Aeropuerto</strong>
                            <small>Oficial de aduanas.</small>
                        </div>
                    </div>

                    <div class="role-card" onclick="selectScenario('interview', 'work', 'Entrevista', this)">
                        <span class="material-icons" style="color: #CF6679;">work</span>
                        <div>
                            <strong>Entrevista</strong>
                            <small>Reclutador de Google.</small>
                        </div>
                    </div>

                    <div class="role-card"
                        onclick="selectScenario('doctor', 'medical_services', 'Consulta M茅dica', this)">
                        <span class="material-icons" style="color: #81C995;">medical_services</span>
                        <div>
                            <strong>Doctor</strong>
                            <small>Describe tus s铆ntomas.</small>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <!-- Status Caption (Pensando / Errores) -->
        <div id="live-caption" style="display:block;">Haz clic en el orbe para hablar...</div>

        <div class="orb" id="magic-orb">
            <!-- Sound Wave Visualizer (Hidden by default, visible when speaking) -->
            <div class="sound-wave-container">
                <div class="bar"></div>
                <div class="bar"></div>
                <div class="bar"></div>
                <div class="bar"></div>
                <div class="bar"></div>
            </div>
            <span class="material-icons" id="orb-icon">mic</span>
        </div>

        <div class="chat-messages" id="messages-box">
        </div>

        <!-- Botones Flotantes (Historial, Errores y Teclado) -->
        <div class="fab-container">

            <!-- 1. La Orejita (Bot贸n de Ayuda) -->
            <button onclick="window.mostrarAyudaFonetica(this.dataset.text)" title="Mejorar Pronunciaci贸n"
                id="btn-pronunciation-help" class="fab-btn fab-help">
                <span class="material-icons" style="font-size: 1.5rem;">hearing</span>
            </button>

            <!-- 2. Historial de Pronunciaci贸n -->
            <button onclick="togglePronunciationDrawer()" title="Historial de Pronunciaci贸n" class="fab-btn fab-red">
                <span class="material-icons">graphic_eq</span>
            </button>

            <!-- 3. Errores Gramaticales -->
            <button onclick="toggleErrorsDrawer()" title="Ver errores gramaticales" id="btn-errors-toggle"
                class="fab-btn fab-red">
                <span class="material-icons">rule</span>
            </button>



            <!-- 5. Teclado -->
            <button onclick="toggleKeyboard()" title="Escribir texto" class="fab-btn">
                <span class="material-icons">keyboard</span>
            </button>
        </div>

        <!-- Bot贸n Flotante de NOTAS (Posici贸n Personalizada: Derecha Centro) -->
        <button onclick="toggleNotesDrawer()" title="Mis Notas" class="fab-btn"
            style="position: fixed; right: 20px; top: 45%; transform: translateY(-50%); background:#FFD700; color:black; z-index: 1000; width: 50px; height: 50px; box-shadow: 0 4px 10px rgba(0,0,0,0.3);">
            <span class="material-icons">sticky_note_2</span>
        </button>

        <!-- Bot贸n Flotante de HISTORIAL (Debajo de Notas) -->
        <button onclick="toggleHistoryDrawer()" title="Historial y Guardar Notas" class="fab-btn"
            style="position: fixed; right: 20px; top: 55%; transform: translateY(-50%); background:#03DAC6; color:black; z-index: 1000; width: 50px; height: 50px; box-shadow: 0 4px 10px rgba(0,0,0,0.3);">
            <span class="material-icons">history</span>
        </button>

        <div id="keyboard-area" style="display:none; position:absolute; bottom:20px; right: 80px; width:300px;">
            <input type="text" id="text-input" class="input-box"
                style="background:#222; border:1px solid #444; display:block; width:100%; border-radius:20px; padding: 10px; color: white;"
                placeholder="Escribe aqu铆...">
        </div>

    </main>



    <div id="levelup-popup" class="levelup-overlay">
        <div class="levelup-card">
            <span class="material-icons" style="font-size: 5rem; color: #FFD700;">emoji_events</span>
            <h2>隆NIVEL ASCENDIDO!</h2>
            <p>Ahora eres nivel <span id="new-level-num" style="font-weight:bold; color:#BB86FC;">2</span></p>
            <button onclick="document.getElementById('levelup-popup').classList.remove('active')">隆GENIAL!</button>
        </div>
    </div>



    <!-- Errors Drawer -->
    <aside class="errors-drawer" id="errors-drawer">
        <div class="drawer-header">
            <h3>Errores Gramaticales</h3>
            <button onclick="toggleErrorsDrawer()" style="background:none; border:none; color:#888; cursor:pointer;">
                <span class="material-icons">close</span>
            </button>
        </div>
        <div class="drawer-body" id="errors-box">
            <p class="no-errors-msg" style="color: #666; text-align: center; margin-top: 20px;">No hay errores en
                esta
                conversaci贸n.</p>
        </div>
    </aside>

    <!-- Pronunciation Drawer -->
    <aside class="errors-drawer" id="pronunciation-drawer">
        <div class="drawer-header">
            <h3>Historial de Pronunciaci贸n</h3>
            <button onclick="togglePronunciationDrawer()"
                style="background:none; border:none; color:#888; cursor:pointer;">
                <span class="material-icons">close</span>
            </button>
        </div>
        <div class="drawer-body" id="pronunciation-box">
            <p class="no-errors-msg" style="color: #666; text-align: center; margin-top: 20px;">Cargando
                historial...
            </p>
        </div>
    </aside>

    <!-- Notes Drawer (NUEVO) -->
    <aside class="errors-drawer" id="notes-drawer">
        <div class="drawer-header" style="border-bottom: 2px solid #FFD700;">
            <h3>Mis Notas de Estudio </h3>
            <button onclick="toggleNotesDrawer()" style="background:none; border:none; color:#888; cursor:pointer;">
                <span class="material-icons">close</span>
            </button>
        </div>
        <div class="drawer-body" id="notes-box">
            <p class="no-errors-msg" style="color: #666; text-align: center; margin-top: 20px;">Cargando notas...
            </p>
        </div>
    </aside>

    <!-- History Drawer (NUEVO: Para guardar notas desde el historial) -->
    <aside class="errors-drawer" id="history-drawer">
        <div class="drawer-header" style="border-bottom: 2px solid #03DAC6;">
            <h3>Historial de Chat </h3>
            <button onclick="toggleHistoryDrawer()" style="background:none; border:none; color:#888; cursor:pointer;">
                <span class="material-icons">close</span>
            </button>
        </div>
        <div class="drawer-body" id="full-history-box">
            <!-- AQU SE INSERTAN LOS MENSAJES CON BOTN DE GUARDAR NOTA -->
        </div>
    </aside>

    <div id="game-hub-overlay" class="game-hub-overlay">
        <div class="game-hub-card">
            <button class="btn-close-hub" onclick="closeGameHub()">&times;</button>

            <div class="hub-header">
                <h2>Mi Progreso</h2>
                <div class="hub-tabs">
                    <button class="tab-btn active" onclick="switchTab('tab-stats')">Estad铆sticas</button>
                    <button class="tab-btn" onclick="switchTab('tab-leaderboard')">Ranking Global</button>
                    <button class="tab-btn" onclick="switchTab('tab-config')">Configuraci贸n</button>
                </div>
            </div>

            <div class="hub-content">
                <div id="tab-stats" class="tab-pane active">
                    <div class="big-stats-grid">
                        <div class="big-stat-box">
                            <span class="material-icons" style="color:#FFD700; font-size:3rem;">military_tech</span>
                            <h3 id="hub-level">{{ progreso.nivel }}</h3>
                            <p>Nivel Actual</p>
                        </div>
                        <div class="big-stat-box">
                            <span class="material-icons" style="color:#03DAC6; font-size:3rem;">bolt</span>
                            <h3 id="hub-xp">{{ progreso.experiencia }}</h3>
                            <p>XP Total</p>
                        </div>
                        <div class="big-stat-box">
                            <span class="material-icons"
                                style="color:#FF5722; font-size:3rem;">local_fire_department</span>
                            <h3 id="hub-streak">{{ progreso.racha_actual }}</h3>
                            <p>Racha (D铆as)</p>
                        </div>
                    </div>
                    <div style="text-align:center; margin-top:20px; color:#888;">
                        <p>隆Sigue practicando para alcanzar el siguiente nivel!</p>
                    </div>
                </div>

                <div id="tab-leaderboard" class="tab-pane">
                    <table class="leaderboard-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Usuario</th>
                                <th>Nivel</th>
                                <th>XP</th>
                            </tr>
                        </thead>
                        <tbody id="leaderboard-body">
                            <tr>
                                <td colspan="4">Cargando ranking...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div id="tab-config" class="tab-pane">
                    <div class="config-item">
                        <div>
                            <strong>Mostrar Gamificaci贸n</strong>
                            <p>Activa o desactiva la barra superior.</p>
                        </div>
                        <label class="switch">
                            <input type="hidden" id="real-value-show"
                                value="{{ progreso.mostrar_gamificacion|yesno:'true,false' }}">

                            <input type="checkbox" id="check-show-game" autocomplete="off"
                                onchange="saveGameSettings()">
                            <span class="slider round"></span>
                        </label>
                    </div>

                    <div class="config-item">
                        <div>
                            <strong>Ranking Global</strong>
                            <p>Aparecer en la tabla p煤blica.</p>
                        </div>
                        <label class="switch">
                            <input type="hidden" id="real-value-public"
                                value="{{ progreso.publico_en_leaderboard|yesno:'true,false' }}">

                            <input type="checkbox" id="check-public-game" autocomplete="off"
                                onchange="saveGameSettings()">
                            <span class="slider round"></span>
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="tutorial-overlay" class="tutorial-overlay"></div>

    <div id="tutorial-card" class="tutorial-card">
        <h3 id="tut-title">T铆tulo</h3>
        <p id="tut-desc">Descripci贸n...</p>
        <div class="tutorial-controls">
            <button class="btn-skip" onclick="endTutorial()">Saltar</button>
            <span id="tut-step" class="step-indicator">1/4</span>
            <button class="btn-next" onclick="nextStep()">Siguiente</button>
        </div>
    </div>


    <!-- Theme Logic (Global) -->
    <script src="{% static 'js/theme.js' %}"></script>

    <script>
        // --- VARIABLES GLOBALES ---
        let recognition;
        let isListening = false;
        let isSpeaking = false;
        let silenceTimer;
        let currentConversationId = null;
        let typeWriterTimeout;
        let currentUserBubble = null;
        let currentBotBubble = null;
        let currentDrawerBubble = null;
        let currentConfidence = 0.0; // Global for confidence
        let currentPronunciationTip = null; // Global for tip
        let mediaRecorder;
        let audioChunks = [];

        // Elementos DOM
        const orb = document.getElementById('magic-orb');
        const orbIcon = document.getElementById('orb-icon');
        const liveCaption = document.getElementById('live-caption');
        const messagesBox = document.getElementById('messages-box');
        const fullHistoryBox = document.getElementById('full-history-box');
        const errorsBox = document.getElementById('errors-box');
        const textInput = document.getElementById('text-input');
        const btnErrorsToggle = document.getElementById('btn-errors-toggle');

        // --- INICIALIZACIN ---
        document.addEventListener('DOMContentLoaded', () => {
            initSpeechRecognition();
            orb.addEventListener('click', toggleListening);

            // LA LGICA DE TEMA AHORA EST EN theme.js
            // Se ejecuta autom谩ticamente por el evento DOMContentLoaded de ese archivo
        });

        // --- MOBILE SIDEBAR TOGGLE ---
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.toggle('open');
            overlay.classList.toggle('active');
        }

        // --- CONTROL DE DRAWERS ---
        // --- CONTROL DE DRAWERS ---
        function closeAllDrawers() {
            document.querySelectorAll('.errors-drawer').forEach(el => el.classList.remove('open'));
            document.getElementById('btn-errors-toggle').classList.remove('notification-active');
        }

        function toggleHistoryDrawer() {
            const drawer = document.getElementById('history-drawer');
            const wasOpen = drawer.classList.contains('open');
            closeAllDrawers();
            if (!wasOpen) drawer.classList.add('open');
        }

        function toggleNotesDrawer() {
            const drawer = document.getElementById('notes-drawer');
            const wasOpen = drawer.classList.contains('open');
            closeAllDrawers();
            if (!wasOpen) {
                drawer.classList.add('open');
                loadNotes(); // Cargar notas al abrir
            }
        }

        function toggleErrorsDrawer() {
            const drawer = document.getElementById('errors-drawer');
            const wasOpen = drawer.classList.contains('open');
            closeAllDrawers();
            if (!wasOpen) drawer.classList.add('open');
        }

        function togglePronunciationDrawer() {
            const drawer = document.getElementById('pronunciation-drawer');
            const wasOpen = drawer.classList.contains('open');
            closeAllDrawers();
            if (!wasOpen) drawer.classList.add('open');
        }

        // --- AUDIO CUES (Web Audio API) ---
        const cueAudioCtx = new (window.AudioContext || window.webkitAudioContext)();

        function playStartSound() {
            const osc = cueAudioCtx.createOscillator();
            const gain = cueAudioCtx.createGain();
            osc.connect(gain);
            gain.connect(cueAudioCtx.destination);
            osc.type = 'sine';
            osc.frequency.setValueAtTime(600, cueAudioCtx.currentTime);
            osc.frequency.linearRampToValueAtTime(900, cueAudioCtx.currentTime + 0.12);
            gain.gain.setValueAtTime(0.18, cueAudioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, cueAudioCtx.currentTime + 0.2);
            osc.start(cueAudioCtx.currentTime);
            osc.stop(cueAudioCtx.currentTime + 0.2);
        }

        function playStopSound() {
            const osc = cueAudioCtx.createOscillator();
            const gain = cueAudioCtx.createGain();
            osc.connect(gain);
            gain.connect(cueAudioCtx.destination);
            osc.type = 'sine';
            osc.frequency.setValueAtTime(700, cueAudioCtx.currentTime);
            osc.frequency.linearRampToValueAtTime(400, cueAudioCtx.currentTime + 0.15);
            gain.gain.setValueAtTime(0.15, cueAudioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, cueAudioCtx.currentTime + 0.25);
            osc.start(cueAudioCtx.currentTime);
            osc.stop(cueAudioCtx.currentTime + 0.25);
        }

        // --- RECONOCIMIENTO DE VOZ (Web Speech API) ---
        function initSpeechRecognition() {
            if (!('webkitSpeechRecognition' in window)) {
                alert("Tu navegador no soporta reconocimiento de voz. Usa Chrome.");
                return;
            }
            recognition = new webkitSpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'es-ES';

            recognition.onstart = () => {
                isListening = true;
                currentConfidence = 0.0; // Reset confidence
                orb.classList.add('listening');
                orbIcon.innerText = 'graphic_eq';
                liveCaption.innerText = "Escuchando..."; // Restaurado
                liveCaption.style.display = 'block';
                const bubbles = createMessageBubble('user', '...', true);
                currentUserBubble = bubbles.orb;
                currentDrawerBubble = bubbles.drawer;

                // --- INICIA GRABACIN DE AUDIO ---
                navigator.mediaDevices.getUserMedia({ audio: true })
                    .then(stream => {
                        mediaRecorder = new MediaRecorder(stream);
                        mediaRecorder.start();
                        audioChunks = [];
                        mediaRecorder.ondataavailable = event => {
                            audioChunks.push(event.data);
                        };
                    })
                    .catch(e => console.error("Error micr贸fono:", e));
            };

            recognition.onresult = (event) => {
                clearTimeout(silenceTimer);
                // ... (rest is same, no changes needed inside onresult mostly)
                let transcript = '';
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    let chunk = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        currentConfidence = event.results[i][0].confidence;
                    }
                    if (transcript.length > 0 && !transcript.endsWith(' ') && !chunk.startsWith(' ')) {
                        transcript += ' ';
                    }
                    transcript += chunk;
                }

                if (currentUserBubble) {
                    const bubbleContent = currentUserBubble.querySelector('.bubble-content') || currentUserBubble.querySelector('.bubble');
                    if (bubbleContent) bubbleContent.textContent = transcript;
                    messagesBox.scrollTo({ top: messagesBox.scrollHeight, behavior: 'smooth' });
                }
                if (currentDrawerBubble) {
                    const bubbleContent = currentDrawerBubble.querySelector('.bubble-content') || currentDrawerBubble.querySelector('.bubble');
                    if (bubbleContent) bubbleContent.textContent = transcript;
                    fullHistoryBox.scrollTo({ top: fullHistoryBox.scrollHeight, behavior: 'smooth' });
                }

                silenceTimer = setTimeout(() => {
                    stopListening();
                }, 2000);
            };

            recognition.onend = () => {
                if (!isSpeaking) {
                    if (currentUserBubble) {
                        const bubbleContent = currentUserBubble.querySelector('.bubble-content') || currentUserBubble.querySelector('.bubble');
                        const text = bubbleContent.textContent;

                        if (text.trim() !== "" && text !== "...") {
                            // Detener grabaci贸n y procesar con Backend
                            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                                mediaRecorder.stop();
                                mediaRecorder.onstop = async () => {
                                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                                    // Procesamos con backend para obtener Score Estricto
                                    const backendData = await procesarAudioBackend(audioBlob);

                                    // Si el backend da un score, lo usamos (Es m谩s estricto)
                                    const finalConfidence = backendData ? backendData.confidence : currentConfidence;

                                    // 1. Inyectar Score HTML
                                    const scoreHtml = getScoreHtml(finalConfidence);

                                    // GESTIN DEL BOTN FLOTANTE (ESTTICO)
                                    const fab = document.getElementById('btn-pronunciation-help');
                                    if (finalConfidence < 0.88) {
                                        // Mostramos el bot贸n flotante
                                        fab.dataset.text = text;
                                        fab.style.display = 'flex';
                                    } else {
                                        fab.style.display = 'none';
                                    }

                                    if (scoreHtml) {
                                        bubbleContent.innerHTML = scoreHtml + text;
                                    }
                                    if (currentDrawerBubble) {
                                        const drawerContent = currentDrawerBubble.querySelector('.bubble');
                                        if (drawerContent) drawerContent.innerHTML = scoreHtml + text;
                                    }

                                    // 2. Enviar a cerebro
                                    processText(text, false, finalConfidence);
                                };
                            } else {
                                // Fallback si no grab贸 audio
                                // Fallback si no grab贸 audio
                                const scoreHtml = getScoreHtml(currentConfidence);

                                const fab = document.getElementById('btn-pronunciation-help');
                                if (currentConfidence < 0.85 && currentConfidence > 0) {
                                    fab.dataset.text = text;
                                    fab.style.display = 'flex';
                                } else {
                                    fab.style.display = 'none';
                                }

                                if (scoreHtml) bubbleContent.innerHTML = scoreHtml + text;
                                processText(text, false, currentConfidence);
                            }

                            currentUserBubble = null;
                            currentDrawerBubble = null;

                        } else {
                            currentUserBubble.remove();
                            if (currentDrawerBubble) currentDrawerBubble.remove();
                            resetOrb();
                        }
                    } else {
                        resetOrb();
                    }
                }
            };

            recognition.onerror = (event) => {
                console.error("Error STT:", event.error);
                resetOrb();
                if (currentUserBubble) currentUserBubble.remove();
                if (currentDrawerBubble) currentDrawerBubble.remove();
                liveCaption.innerText = "Error de micr贸fono.";
            };
        }

        function toggleListening() {
            if (isListening) {
                stopListening();
            } else if (isSpeaking) {
                window.speechSynthesis.cancel();
                resetOrb();
            } else {
                startListening();
            }
        }

        function startListening() {
            // Ocultar bot贸n de ayuda anterior al empezar a hablar
            document.getElementById('btn-pronunciation-help').style.display = 'none';
            try {
                if (cueAudioCtx.state === 'suspended') cueAudioCtx.resume();
                playStartSound();
                recognition.start();
            } catch (e) {
                console.error(e);
            }
        }

        function stopListening() {
            playStopSound();
            recognition.stop();
        }

        // --- NUEVO: Procesar audio con Backend para Score Estricto ---
        async function procesarAudioBackend(audioBlob) {
            try {
                const reader = new FileReader();
                return new Promise((resolve, reject) => {
                    reader.onloadend = async () => {
                        const base64Audio = reader.result.split(',')[1];
                        try {
                            const sttRes = await fetch('/api/stt/', {
                                method: 'POST',
                                body: JSON.stringify({ audio_base64: base64Audio }),
                                headers: { 'X-CSRFToken': getCookie('csrftoken') }
                            });
                            const sttData = await sttRes.json();
                            resolve(sttData);
                        } catch (e) {
                            console.error("Error Backend STT:", e);
                            resolve(null);
                        }
                    };
                    reader.readAsDataURL(audioBlob);
                });
            } catch (e) {
                return null;
            }
        }

        // --- PROCESAMIENTO ---
        async function processText(text, createBubble = true, confidence = null) {
            orb.classList.remove('listening');
            orb.classList.add('thinking');
            orbIcon.innerText = 'hourglass_empty';
            liveCaption.innerText = "Pensando...";

            if (createBubble) {
                agregarMensaje('user', text, confidence);
            }

            // Enviamos el confidence capturado (o 1.0 si es nulo)
            // Asumimos 'es-ES' por defecto o detectado previamente, pero aqu铆 simplificamos a enviar la confianza
            enviarAlCerebro(text, 'es-ES', confidence !== null ? confidence : 1.0);
        }

        // Actualiza la firma para aceptar confidence
        async function enviarAlCerebro(texto, idiomaDetectado = 'es-ES', confidenceScore = 1.0) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 20000);

            const bubbles = createMessageBubble('bot', '...', true);
            currentBotBubble = bubbles.orb;
            const currentBotDrawerBubble = bubbles.drawer;

            try {
                const res = await fetch('/chat_interaction/', {
                    method: 'POST',
                    body: JSON.stringify({
                        text: texto,
                        conversation_id: currentConversationId,
                        detected_lang: idiomaDetectado,
                        scenario: currentScenario,
                        confidence: confidenceScore // <--- ENVIAMOS EL PUNTAJE
                    }),
                    headers: { 'X-CSRFToken': getCookie('csrftoken') },
                    signal: controller.signal
                });
                clearTimeout(timeoutId);

                if (!res.ok) {
                    let errorMessage = `Server Error: ${res.status}`;
                    try {
                        const errData = await res.json();
                        if (errData.error) errorMessage = errData.error;
                    } catch (jsonErr) { }
                    throw new Error(errorMessage);
                    if (currentBotDrawerBubble) currentBotDrawerBubble.remove();
                }

                const data = await res.json();
                console.log(" SERVER DEBUG > EnviarAlCerebro Data:", data);

                if (data.error) {
                    resetOrb();
                    liveCaption.innerText = "Error: " + data.error;
                    if (currentBotBubble) currentBotBubble.remove();
                    if (currentBotDrawerBubble) currentBotDrawerBubble.remove();
                    return;
                }

                // GUARDAMOS EL TIP GLOBALMENTE
                currentPronunciationTip = data.tip_pronunciacion || null;

                // --- MOSTRAR TIP DE PRONUNCIACIN (Coach Panel) ---
                if (data.tip_pronunciacion) {
                    mostrarTipPronunciacion(data.tip_pronunciacion);

                    // ACTUALIZAR BOTN FLOTANTE CON LA CORRECCIN FONTICA
                    const fab = document.getElementById('btn-pronunciation-help');
                    const correction = data.texto_corregido_fonetico;

                    // FORCE SHOW BUTTON IF IT WAS HIDDEN
                    fab.style.display = 'flex';

                    // Solo actualizamos si el bot贸n est谩 visible
                    if (data.tip_pronunciacion) {
                        if (correction) {
                            fab.dataset.correction = correction;
                        }
                        fab.dataset.tip = data.tip_pronunciacion;
                    }
                }

                if (data.gamification) {
                    const game = data.gamification;
                    // Animamos UI de XP/Nivel
                    const xpLabel = document.getElementById('stat-xp');
                    const currentXP = parseInt(xpLabel.innerText);
                    const targetXP = game.xp_actual;

                    if (targetXP > currentXP) {
                        xpLabel.innerText = targetXP + " XP";
                        document.getElementById('hub-xp').innerText = targetXP;
                    }
                    document.getElementById('stat-level').innerText = "Nvl " + game.nivel_actual;
                    document.getElementById('stat-streak').innerText = game.racha_actual;
                    document.getElementById('hub-level').innerText = game.nivel_actual;
                    document.getElementById('hub-streak').innerText = game.racha_actual;

                    if (game.subio_nivel) {
                        document.getElementById('new-level-num').innerText = game.nivel_actual;
                        document.getElementById('levelup-popup').classList.add('active');
                    }
                }

                if (currentConversationId === null && data.conversation_id) {
                    currentConversationId = data.conversation_id;
                    agregarChatAlHistorial(data.conversation_id, data.conversation_title || "Nueva Conversaci贸n");
                }

                orb.classList.remove('thinking');
                orb.classList.add('speaking');
                orbIcon.innerText = 'volume_up';
                liveCaption.innerText = "";
                isSpeaking = true;

                if (data.audio_base64) {
                    const audio = new Audio("data:audio/mp3;base64," + data.audio_base64);
                    try {
                        setupVisualizer(audio);
                    } catch (err) { console.error(err); }

                    audio.play();
                    audio.onended = () => {
                        isSpeaking = false;
                        resetOrb();
                    };
                } else {
                    setTimeout(() => {
                        isSpeaking = false;
                        resetOrb();
                    }, Math.min(data.bot_text.length * 50, 5000));
                }

                if (currentBotBubble) {
                    const bubbleContent = currentBotBubble.querySelector('.bubble-content') || currentBotBubble.querySelector('.bubble');
                    typeWriter(data.bot_text, bubbleContent, currentBotDrawerBubble ? (currentBotDrawerBubble.querySelector('.bubble-content') || currentBotDrawerBubble.querySelector('.bubble')) : null);
                } else {
                    agregarMensaje('bot', data.bot_text);
                }

                if (data.correccion) {
                    mostrarCorreccion(texto, data.correccion, data.explicacion_regla);
                    agregarErrorAlDrawer(texto, data.correccion, data.explicacion_regla);
                }

            } catch (e) {
                clearTimeout(timeoutId);
                console.error(e);
                resetOrb();

                let errorMsg = e.message || "Error desconocido";
                if (e.name === 'AbortError') {
                    errorMsg = "El cerebro tard贸 demasiado.";
                } else if (errorMsg.includes('Failed to fetch') || errorMsg.includes('NetworkError')) {
                    errorMsg = "Error de conexi贸n (Red).";
                }

                liveCaption.innerText = errorMsg;
                if (currentBotBubble) currentBotBubble.remove();
                if (currentBotDrawerBubble) currentBotDrawerBubble.remove();
            }
        }

        // Helper para generar HTML del score
        function getScoreHtml(confidence) {
            if (confidence === null || confidence === undefined) return '';
            let colorClass = 'score-low';
            let label = 'Bajo';
            if (confidence >= 0.95) { colorClass = 'score-high'; label = 'Nativo'; }
            else if (confidence >= 0.88) { colorClass = 'score-mid'; label = 'Bien'; }

            return `
                <span class="score-tooltip" title="Precisi贸n: ${Math.round(confidence * 100)}%">${label}</span>
                <span class="pronunciation-score ${colorClass}"></span>
            `;
        }

        // --- UTILIDADES ---
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function typeWriter(text, element, drawerElement, speed = 30) {
            clearTimeout(typeWriterTimeout);
            element.textContent = "";
            if (drawerElement) drawerElement.textContent = "";

            let i = 0;
            function type() {
                if (i < text.length) {
                    const char = text.charAt(i);
                    element.textContent += char;
                    if (drawerElement) drawerElement.textContent += char;
                    i++;
                    typeWriterTimeout = setTimeout(type, speed);
                    messagesBox.scrollTo({ top: messagesBox.scrollHeight, behavior: 'smooth' });
                    if (drawerElement) fullHistoryBox.scrollTo({ top: fullHistoryBox.scrollHeight, behavior: 'smooth' });
                }
            }
            type();
        }

        // --- REAL-TIME AUDIO VISUALIZER ---
        let audioCtx, analyser, visualizerSource;
        const BASE_HEIGHTS = [30, 75, 40, 75, 30]; // Matching CSS 'N' shape

        function setupVisualizer(audioElement) {
            // 1. Init AudioContext on user interaction (first time) or reuse
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }

            // 2. Prepare Analyser
            if (!analyser) {
                analyser = audioCtx.createAnalyser();
                analyser.fftSize = 64; // Low resolution enough for 5 bars
                analyser.smoothingTimeConstant = 0.5;
            }

            // 3. Connect Graph
            // Note: createMediaElementSource can throw if element is already connected.
            // Since we create 'new Audio()' every time, it's safe.
            visualizerSource = audioCtx.createMediaElementSource(audioElement);
            visualizerSource.connect(analyser);
            analyser.connect(audioCtx.destination);

            // 4. Start Animation Loop
            drawVisualizer();
        }

        function drawVisualizer() {
            if (!isSpeaking) return;

            // Loop
            requestAnimationFrame(drawVisualizer);

            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            analyser.getByteFrequencyData(dataArray);

            const bars = document.querySelectorAll('.sound-wave-container .bar');

            // Map freq data to bars. simple mapping for now.
            // We use specific indices to capture Bass -> Treble roughly.
            // With fftSize 64, binCount is 32.
            // Indices: 0-4 (Bass), 5-10 (Mid), 11-20 (High)
            const indices = [1, 3, 6, 12, 20];

            bars.forEach((bar, i) => {
                const val = dataArray[indices[i]] || 0;
                // Boost factor: 0-255 -> 0-60% height boost
                const boost = (val / 255) * 60;

                // Final Height = Base + Boost (Max 100%)
                let finalH = BASE_HEIGHTS[i] + boost;
                if (finalH > 100) finalH = 100;

                bar.style.height = finalH + '%';
            });
        }

        function resetOrb() {
            orb.classList.remove('listening', 'speaking', 'thinking');
            orbIcon.innerText = 'mic';
            liveCaption.innerText = "Haz clic para hablar...";
            isListening = false;
            isSpeaking = false;

            // Reset bars to base state explicitly
            const bars = document.querySelectorAll('.sound-wave-container .bar');
            bars.forEach((bar, i) => {
                bar.style.height = BASE_HEIGHTS[i] + '%';
            });
        }

        function createMessageBubble(rol, texto, isTransient = true, confidence = null) {
            let scoreHtml = '';

            // Bot贸n de guardar nota (AHORA SOLO PARA EL DRAWER)
            // Usamos un icono de disquete o nota
            let saveNoteBtn = `
                <button onclick="saveNote(this, '${rol}')" class="save-note-btn" title="Guardar en Notas">
                    <span class="material-icons" style="font-size:16px;">bookmark_border</span>
                </button>
            `;

            console.log(`createMessageBubble - Rol: ${rol}, Conf: ${confidence}, Type: ${typeof confidence}`); // DEBUG
            if (rol === 'user' && confidence !== null) {
                scoreHtml = getScoreHtml(confidence);
            }

            let orbDiv = null;
            if (isTransient) {
                orbDiv = document.createElement('div');
                orbDiv.classList.add('message', rol);
                // EN EL MAIN CHAT: SIN BOTN DE NOTAS (LIMPIO)
                orbDiv.innerHTML = `<div class="bubble">${scoreHtml}<span class="bubble-content">${texto}</span></div>`;
                messagesBox.appendChild(orbDiv);
                messagesBox.scrollTo({ top: messagesBox.scrollHeight, behavior: 'smooth' });

                if (messagesBox.children.length > 5) {
                    messagesBox.removeChild(messagesBox.firstChild);
                }
            }

            const drawerDiv = document.createElement('div');
            drawerDiv.classList.add('message', rol);
            // EN EL DRAWER: CON BOTN DE NOTAS
            drawerDiv.innerHTML = `<div class="bubble">${scoreHtml}<span class="bubble-content">${texto}</span>${saveNoteBtn}</div>`;
            fullHistoryBox.appendChild(drawerDiv);
            fullHistoryBox.scrollTo({ top: fullHistoryBox.scrollHeight, behavior: 'smooth' });

            return { orb: orbDiv, drawer: drawerDiv };
        }



        function agregarMensaje(rol, texto, confidence = null) {
            createMessageBubble(rol, texto, true, confidence);
        }

        function agregarErrorAlDrawer(original, corregido, explicacion) {
            const errorsBox = document.getElementById('errors-box');
            // Remove "no errors" message if exists (checked by class)
            const emptyMsg = errorsBox.querySelector('.no-errors-msg');
            if (emptyMsg) emptyMsg.remove();

            const errorCard = document.createElement('div');
            errorCard.classList.add('error-card');

            errorCard.innerHTML = `
                <div style="font-style:italic; font-size:0.9rem; color:#ccc; margin-bottom:5px;">"${original}"</div>
                <div style="font-weight:bold; color:#FF5252; margin-bottom:5px;">${corregido}</div>
                <div style="font-size:0.85rem; color:#bbb;">Explicaci贸n: ${explicacion}</div>
            `;
            errorsBox.prepend(errorCard);

            // Mostrar notificaci贸n en el bot贸n
            btnErrorsToggle.classList.add('notification-active');
        }

        function mostrarTipPronunciacion(tip) {
            const panel = document.getElementById('coach-panel');
            const card = panel.querySelector('.coach-card');

            // Cambiamos el estilo para que parezca de "Audio/O铆do"
            card.style.borderLeft = "4px solid #FFEA00"; // Amarillo

            panel.querySelector('.coach-title').innerHTML = `
                <span class="material-icons" style="color:#FFEA00;">hearing</span>
                Mejora tu Pronunciaci贸n
            `;

            document.getElementById('coach-original').innerHTML = ""; // Limpiamos lo anterior
            document.getElementById('coach-correction').innerHTML = "";

            // Usamos el espacio de explicaci贸n para el tip
            document.getElementById('coach-explanation').innerHTML = `
                <div style="font-size:1.1rem; color:#FFF; margin-top:10px;">
                    ${tip}
                </div>
                <div style="font-size:0.8rem; color:#888; margin-top:5px;">
                    Intenta decirlo de nuevo m谩s despacio.
                </div>
            `;

            panel.classList.add('active');

            // Ocultar autom谩ticamente despu茅s de 10 segundos
            setTimeout(() => {
                panel.classList.remove('active');
            }, 10000);
        }

        window.toggleKeyboard = function () {
            const kbd = document.getElementById('keyboard-area');
            const input = document.getElementById('text-input');
            if (kbd.style.display === 'none') {
                kbd.style.display = 'block';
                input.focus();
            } else {
                kbd.style.display = 'none';
            }
        }

        // --- FUNCIONES DE AYUDA FONTICA (POPOVER) ---
        let phraseToPlay = "";

        function mostrarAyudaFonetica(fraseUsuario) {
            const popover = document.getElementById('pronunciation-popover');
            const popoverText = document.getElementById('popover-text');

            phraseToPlay = fraseUsuario; // Guardamos la frase para reproducirla

            // Usamos el tip que Gemini nos dio en la 煤ltima respuesta
            if (currentPronunciationTip) {
                popoverText.innerHTML = currentPronunciationTip;
            } else {
                popoverText.innerHTML = "No hay un tip espec铆fico disponible para esta frase, pero intenta escuchar la pronunciaci贸n correcta.";
            }

            popover.classList.add('visible');
        }

        function cerrarAyudaFonetica() {
            document.getElementById('pronunciation-popover').classList.remove('visible');
        }

        async function reproducirPalabra() {
            if (!phraseToPlay) return;

            const btn = document.getElementById('play-pronunciation-btn');
            const originalContent = btn.innerHTML;
            btn.innerHTML = '<span class="material-icons spinning">sync</span> Cargando...';
            btn.disabled = true;

            try {
                // Llamamos a una nueva API para generar el audio de la frase
                const res = await fetch('/api/tts_word/', {
                    method: 'POST',
                    body: JSON.stringify({ text: phraseToPlay, lang: 'en-US' }), // Forzamos ingl茅s
                    headers: { 'X-CSRFToken': getCookie('csrftoken') }
                });
                const data = await res.json();

                if (data.audio_base64) {
                    const audio = new Audio("data:audio/mp3;base64," + data.audio_base64);
                    audio.play();
                }
            } catch (e) {
                console.error("Error TTS:", e);
            } finally {
                btn.innerHTML = originalContent;
                btn.disabled = false;
            }
        }

        textInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && textInput.value.trim() !== "") {
                const texto = textInput.value;
                processText(texto);
                textInput.value = '';
                document.getElementById('keyboard-area').style.display = 'none';
            }
        });

        // --- GESTIN DE CONVERSACIONES ---
        async function cargarConversacion(id) {
            currentConversationId = id;
            document.querySelectorAll('.history-item').forEach(el => el.classList.remove('active'));
            const activeItem = document.getElementById(`chat-item-${id}`);
            if (activeItem) activeItem.classList.add('active');

            // Limpiar ambos contenedores
            messagesBox.innerHTML = '';
            fullHistoryBox.innerHTML = '';
            errorsBox.innerHTML = '<p style="color:#888; text-align:center;">Cargando errores...</p>';

            try {
                const response = await fetch(`/api/conversations/${id}/`);
                const data = await response.json();

                // 1. Mensajes
                if (data.mensajes) {
                    const total = data.mensajes.length;
                    const startOrb = Math.max(0, total - 5); // ltimos 5

                    data.mensajes.forEach((msg, index) => {
                        const rol = msg.rol === 'usuario' ? 'user' : 'bot';
                        // Si es de los 煤ltimos 5, lo mostramos tambi茅n en el orb (isTransient=true)
                        // Si no, solo en el historial (isTransient=false)
                        const showInOrb = index >= startOrb;
                        createMessageBubble(rol, msg.contenido, showInOrb);
                    });
                }

                // 2. Errores
                errorsBox.innerHTML = '';
                if (data.errores && data.errores.length > 0) {
                    data.errores.forEach(err => {
                        agregarErrorAlDrawer(err.original, err.corregido, err.explicacion);
                    });
                } else {
                    errorsBox.innerHTML = '<p class="no-errors-msg" style="color: #666; text-align: center; margin-top: 20px;">No hay errores en esta conversaci贸n.</p>';
                }

            } catch (error) {
                console.error("Error cargando historial:", error);
                errorsBox.innerHTML = '<p style="color:#f28b82;">Error al cargar.</p>';
            }
        }

        function agregarChatAlHistorial(id, titulo) {
            const historyBox = document.getElementById('history-box');
            const emptyMsg = historyBox.querySelector('p');
            if (emptyMsg) emptyMsg.remove();
            document.querySelectorAll('.history-item').forEach(el => el.classList.remove('active'));

            const newItem = document.createElement('div');
            newItem.classList.add('history-item', 'active');
            newItem.id = `chat-item-${id}`;
            newItem.innerText = titulo;
            newItem.onclick = () => cargarConversacion(id);
            historyBox.prepend(newItem);
        }

        // --- MEN DE USUARIO & SETTINGS ---
        const menuTrigger = document.getElementById('user-menu-trigger');
        const menuPopup = document.getElementById('user-menu-popup');

        menuTrigger.addEventListener('click', (e) => {
            e.stopPropagation();
            menuPopup.classList.toggle('visible');
            if (menuPopup.classList.contains('visible')) showSubmenu('view-main');
        });

        document.addEventListener('click', (e) => {
            if (!menuPopup.contains(e.target) && !menuTrigger.contains(e.target)) {
                menuPopup.classList.remove('visible');
            }
        });

        window.showSubmenu = function (viewId) {
            document.querySelectorAll('.submenu-view').forEach(el => el.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
        }

        window.loadErrors = async function () {
            // ... (Funci贸n existente para el men煤 de usuario, no choca con el nuevo drawer)
            showSubmenu('view-errors');
            // ... (Resto igual)
            const container = document.getElementById('errors-list-container');
            container.innerHTML = '<p style="color:#888; text-align:center;">Cargando...</p>';
            try {
                const response = await fetch('/api/settings/errors/');
                const data = await response.json();
                container.innerHTML = '';
                if (data.errores.length === 0) {
                    container.innerHTML = '<p style="color:#888; font-size:0.8rem;">No hay errores a煤n.</p>';
                } else {
                    data.errores.forEach(err => {
                        const item = document.createElement('div');
                        item.className = 'error-item-mini';
                        item.innerHTML = `<strong>"${err.original}"</strong><span> ${err.corregido}</span>`;
                        container.appendChild(item);
                    });
                }
            } catch (error) {
                container.innerHTML = '<p style="color:#f28b82;">Error al cargar.</p>';
            }
        }





        function mostrarCorreccion(original, correccion, explicacion) {
            // Auto-open drawer as requested
            document.getElementById('errors-drawer').classList.add('open');
            document.getElementById('history-drawer').classList.remove('open');
        }

        document.querySelector('.new-chat-btn').addEventListener('click', () => {
            currentConversationId = null;
            messagesBox.innerHTML = '';
            document.querySelectorAll('.history-item').forEach(el => el.classList.remove('active'));
            resetOrb();
            liveCaption.innerText = "Haz clic para hablar...";
        });

        function checkSystemAlerts() {
            fetch('/api/alert/')
                .then(response => response.json())
                .then(data => {
                    const alertBar = document.getElementById('system-alert-bar');
                    if (data.activa) {
                        document.getElementById('system-alert-text').innerText = data.mensaje;
                        alertBar.style.display = 'block';
                    } else {
                        alertBar.style.display = 'none';
                    }
                })
                .catch(err => console.log("Error checking alerts", err));
        }

        // Llamar al cargar la p谩gina
        document.addEventListener('DOMContentLoaded', () => {
            // ... tus otras inicializaciones ...
            checkSystemAlerts();

            // Opcional: Revisar cada 60 segundos autom谩ticamente
            setInterval(checkSystemAlerts, 60000);
        });

        function animateValue(obj, start, end, duration) {
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                obj.innerHTML = Math.floor(progress * (end - start) + start);
                if (progress < 1) {
                    window.requestAnimationFrame(step);
                } else {
                    obj.innerHTML = end; // Asegurar valor final
                }
            };
            window.requestAnimationFrame(step);
        }

        function openGameHub() {
            document.getElementById('game-hub-overlay').classList.add('visible');
            loadLeaderboard(); // Cargar ranking al abrir
        }

        function closeGameHub() {
            document.getElementById('game-hub-overlay').classList.remove('visible');
        }

        // --- SISTEMA DE NOTAS Y Q&A ---


        async function loadNotes() {
            const container = document.getElementById('notes-box');
            container.innerHTML = '<p style="color:#888; text-align:center; margin-top:20px;">Cargando notas...</p>';

            try {
                const res = await fetch('/api/notes/');
                const data = await res.json();

                if (data.notas && data.notas.length > 0) {
                    container.innerHTML = '';
                    data.notas.forEach(nota => {
                        const noteCard = document.createElement('div');
                        noteCard.className = 'note-card'; // Necesitaremos CSS para esto
                        noteCard.innerHTML = `
                            <div class="note-content">${formatNoteText(nota.contenido)}</div>
                            <div class="note-footer">
                                <small>${nota.fecha}</small>
                                <button onclick="deleteNote(${nota.id})" class="delete-note-btn">
                                    <span class="material-icons" style="font-size:16px;">delete</span>
                                </button>
                            </div>
                        `;
                        container.appendChild(noteCard);
                    });
                } else {
                    container.innerHTML = '<p class="no-errors-msg" style="color:#666; text-align:center; margin-top:20px;">No tienes notas guardadas a煤n.</p>';
                }
            } catch (e) {
                console.error("Error loading notes:", e);
                container.innerHTML = '<p style="color:#f28b82; text-align:center;">Error al cargar notas.</p>';
            }
        }

        async function saveNote(btn, rol) {
            // Encontrar el texto de la burbuja correspondiente
            // El bot贸n est谩 DENTRO de .bubble, as铆 que subimos al padre
            const bubble = btn.closest('.bubble');
            // Clonamos para no obtener el texto del bot贸n ni del score
            const clone = bubble.cloneNode(true);

            // Eliminar elementos basura del clon antes de extraer texto
            const trash = clone.querySelectorAll('.score-tooltip, .pronunciation-score, .save-note-btn, .help-btn');
            trash.forEach(el => el.remove());

            const texto = clone.innerText.trim();

            if (!texto) return;

            // Animaci贸n de carga
            const originalIcon = btn.innerHTML;
            btn.innerHTML = '<span class="material-icons spinning" style="font-size:16px;">sync</span>';
            btn.disabled = true;

            try {
                const res = await fetch('/api/notes/save/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contenido: texto })
                });

                if (res.ok) {
                    // xito visual
                    btn.innerHTML = '<span class="material-icons" style="font-size:16px; color:#4CAF50;">check</span>';
                    setTimeout(() => {
                        btn.innerHTML = '<span class="material-icons" style="font-size:16px;">bookmark</span>'; // Icono "relleno" indica guardado
                        btn.disabled = false;
                    }, 2000);

                    // Si el drawer est谩 abierto, recargar
                    if (isNotesDrawerOpen) loadNotes();
                } else {
                    throw new Error("Error saving");
                }
            } catch (e) {
                console.error(e);
                btn.innerHTML = '<span class="material-icons" style="font-size:16px; color:red;">error</span>';
                setTimeout(() => {
                    btn.innerHTML = originalIcon;
                    btn.disabled = false;
                }, 2000);
            }
        }

        let pendingDeleteNoteId = null;

        function showDeleteModal(id) {
            pendingDeleteNoteId = id;
            document.getElementById('delete-confirm-modal').classList.add('visible');
        }

        function hideDeleteModal() {
            document.getElementById('delete-confirm-modal').classList.remove('visible');
            pendingDeleteNoteId = null;
        }

        async function confirmDeleteNote() {
            if (!pendingDeleteNoteId) return;
            const id = pendingDeleteNoteId;
            hideDeleteModal();

            try {
                const res = await fetch(`/api/notes/delete/${id}/`, { method: 'DELETE' });
                if (res.ok) {
                    loadNotes();
                }
            } catch (e) {
                console.error(e);
            }
        }

        // Legacy wrapper: called from note cards
        async function deleteNote(id) {
            showDeleteModal(id);
        }

        function formatNoteText(text) {
            // Simple formateo: convierte saltos de l铆nea en <br>
            return text.replace(/\n/g, '<br>');
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));

            // Activar seleccionada
            document.querySelector(`button[onclick="switchTab('${tabId}')"]`).classList.add('active');
            document.getElementById(tabId).classList.add('active');
        }

        async function loadLeaderboard() {
            const tbody = document.getElementById('leaderboard-body');
            try {
                const res = await fetch('/api/leaderboard/');
                const data = await res.json();

                tbody.innerHTML = '';
                data.leaderboard.forEach((p, index) => {
                    const tr = document.createElement('tr');
                    if (p.es_yo) tr.classList.add('is-me');

                    let medal = '';
                    if (index === 0) medal = ' ';
                    if (index === 1) medal = ' ';
                    if (index === 2) medal = ' ';

                    tr.innerHTML = `
                    <td>${medal}${index + 1}</td>
                    <td style="font-weight:bold; color:white;">${p.username}</td>
                    <td>Nvl ${p.nivel}</td>
                    <td style="color:#BB86FC;">${p.xp} XP</td>
                `;
                    tbody.appendChild(tr);
                });
            } catch (e) { console.error(e); }
        }

        async function saveGameSettings() {
            // 1. Leer el estado ACTUAL visual de los botones
            const showGameElem = document.getElementById('check-show-game');
            const publicGameElem = document.getElementById('check-public-game');

            const showGame = showGameElem.checked;
            const publicGame = publicGameElem.checked;

            console.log("Guardando configuraci贸n:", { mostrar: showGame, publico: publicGame });

            // 2. Aplicar cambio visual a la barra INMEDIATAMENTE
            const bar = document.getElementById('gamification-bar');
            if (bar) {
                bar.style.display = showGame ? 'flex' : 'none';
            }

            // 3. Enviar al servidor
            try {
                const response = await fetch('/api/settings/game/', {
                    method: 'POST',
                    body: JSON.stringify({ mostrar: showGame, publico: publicGame }),
                    headers: { 'X-CSRFToken': getCookie('csrftoken') }
                });

                if (!response.ok) {
                    console.error("Error en servidor al guardar.");
                }
            } catch (e) {
                console.error("Error de conexi贸n:", e);
            }
        }

        // Funci贸n para obtener cookies (CSRF)
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        document.addEventListener("DOMContentLoaded", function () {
            // 1. Obtener los valores reales de la BD (texto "true" o "false")
            const valShow = document.getElementById('real-value-show').value;
            const valPublic = document.getElementById('real-value-public').value;

            console.log("Valores BD recuperados:", valShow, valPublic);

            // 2. Obtener los checkboxes visuales
            const checkShow = document.getElementById('check-show-game');
            const checkPublic = document.getElementById('check-public-game');

            // 3. FORZAR EL ESTADO (Convertir string a boolean)
            checkShow.checked = (valShow === "true");
            checkPublic.checked = (valPublic === "true");

            // 4. Aplicar visualmente la barra superior si es necesario
            const bar = document.getElementById('gamification-bar');
            if (bar) {
                bar.style.display = checkShow.checked ? 'flex' : 'none';
            }
        });

        async function procesarAudio(audioBlob) {
            // ... (FileReader igual) ...
            reader.onloadend = async () => {
                const base64Audio = reader.result.split(',')[1];

                try {
                    // 1. STT (Ahora devuelve detected_lang)
                    const sttRes = await fetch('/api/stt/', {
                        method: 'POST',
                        body: JSON.stringify({ audio_base64: base64Audio }),
                        headers: { 'X-CSRFToken': getCookie('csrftoken') }
                    });
                    const sttData = await sttRes.json();

                    if (sttData.transcript) {
                        console.log("STT Data received:", sttData); // DEBUG
                        liveCaption.innerText = sttData.transcript;
                        agregarMensaje('user', sttData.transcript, sttData.confidence);

                        // 2. ENVIAR AL CEREBRO CON EL IDIOMA DETECTADO
                        // Importante: pasamos detected_lang y confidence
                        console.log(`DEBUG STT FRONTEND: Text="${sttData.transcript}", Lang=${sttData.detected_lang}, Conf=${sttData.confidence}`);
                        enviarAlCerebro(sttData.transcript, sttData.detected_lang, sttData.confidence);
                    }
                    // ...
                } catch (e) { resetOrb(); }
            };
        }

        // --- VARIABLES GLOBALES ---
        let currentScenario = 'general'; // Por defecto

        // --- LGICA DE ESCENARIOS ---
        function openScenarioHub() {
            document.getElementById('scenario-hub-overlay').classList.add('visible');
        }

        function closeScenarioHub() {
            document.getElementById('scenario-hub-overlay').classList.remove('visible');
        }

        function selectScenario(scenarioId, icon, text, cardElement) {
            // 1. Actualizar variable global
            currentScenario = scenarioId;

            // 2. Actualizar UI del selector principal
            document.getElementById('current-scenario-icon').innerText = icon;
            document.getElementById('current-scenario-text').innerText = text;

            // 3. Actualizar estado visual de las tarjetas
            document.querySelectorAll('.role-card').forEach(c => c.classList.remove('active'));
            cardElement.classList.add('active');

            // 4. Cerrar modal
            closeScenarioHub();

            // 5. Opcional: Enviar mensaje de sistema al chat para avisar el cambio
            agregarMensaje('bot', ` Modo cambiado a: ${text}. 隆Empecemos!`);

            // 6. Resetear orbe para dar feedback visual
            orb.style.borderColor = scenarioId === 'general' ? '' : '#FF9800'; // Naranja si es roleplay
        }

        // Actualiza la firma de la funci贸n enviarAlCerebro


        // --- EXPOSE FUNCTIONS TO WINDOW (Fix for inline onclicks) ---
        window.mostrarAyudaFonetica = function (fraseUsuario) {
            console.log("mostrarAyudaFonetica called with:", fraseUsuario); // DEBUG
            const popover = document.getElementById('pronunciation-popover');
            const popoverText = document.getElementById('popover-text');
            const fab = document.getElementById('btn-pronunciation-help');

            // Check for correction
            const correction = fab.dataset.correction;

            if (correction) {
                phraseToPlay = correction; // Play the CORRECTED version
                popoverText.innerHTML = `
                    <div style="margin-bottom: 5px; color: #FFEA00; font-style: italic;">驴Quisiste decir: "${correction}"?</div>
                    ${currentPronunciationTip || "Escucha la diferencia."}
                `;
            } else {
                phraseToPlay = fraseUsuario;
                if (currentPronunciationTip) {
                    popoverText.innerHTML = currentPronunciationTip;
                } else {
                    popoverText.innerHTML = "Tu pronunciaci贸n fue detectada como <b>Correcta</b>.<br>El sistema no gener贸 correcciones.";
                }
            }

            popover.classList.add('visible');
            // Move popover to ensure z-index is respected
            document.body.appendChild(popover);
        };

        // --- PRONUNCIATION DRAWER LOGIC ---
        function togglePronunciationDrawer() {
            const drawer = document.getElementById('pronunciation-drawer');
            const isOpen = drawer.classList.contains('open');

            // Close others
            document.getElementById('history-drawer').classList.remove('open');
            document.getElementById('errors-drawer').classList.remove('open');

            if (!isOpen) {
                drawer.classList.add('open');
                loadPronunciationErrors();
            } else {
                drawer.classList.remove('open');
            }
        }

        async function loadPronunciationErrors() {
            const box = document.getElementById('pronunciation-box');
            if (!currentConversationId) {
                box.innerHTML = '<p class="no-errors-msg">Selecciona un chat primero.</p>';
                return;
            }
            box.innerHTML = '<p class="loading-msg">Cargando...</p>';

            try {
                // Change: Pass conversation_id
                const res = await fetch(`/api/pronunciation-errors/?conversation_id=${currentConversationId}`);
                const data = await res.json();
                console.log(" SERVER DEBUG > LoadPronunciationErrors Data:", data);

                // Change: data.errors instead of data.errores
                if (data.errors && data.errors.length > 0) {
                    box.innerHTML = '';
                    data.errors.forEach(err => {
                        const item = document.createElement('div');
                        item.className = 'error-card';
                        item.style.borderLeft = '4px solid #CF6679';

                        const scorePct = Math.round(err.confidence * 100);
                        const rawText = err.texto_corregido_fonetico || err.texto_original;
                        // Escape double quotes for HTML attribute
                        const safeText = rawText.replace(/"/g, '&quot;');

                        item.innerHTML = `
                            <div class="error-header" style="justify-content: space-between;">
                                <span style="font-size: 0.8rem; color: #999;">${err.timestamp}</span>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span class="score-badge" style="background: #CF6679; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem;">${scorePct}%</span>
                                    <button class="icon-btn-small play-tip-btn" data-text="${safeText}" title="Escuchar pronunciaci贸n">
                                        <span class="material-icons" style="font-size: 1.2rem; color: #BB86FC;">volume_up</span>
                                    </button>
                                </div>
                            </div>
                            <div class="error-original" style="text-decoration: none;">"${err.texto_original}"</div>
                            ${err.texto_corregido_fonetico ? `<div class="error-correction" style="color: #FFEA00;">Intento: "${err.texto_corregido_fonetico}"</div>` : ''}
                            <div class="error-explanation" style="margin-top: 5px;">${err.tip_fonetico}</div>
                        `;
                        box.appendChild(item);
                    });
                } else {
                    box.innerHTML = '<p class="no-errors-msg">No hay historial de pronunciaci贸n en este chat.</p>';
                }
            } catch (e) {
                console.error(e);
                box.innerHTML = '<p class="error-msg">Error al cargar historial.</p>';
            }
        }


        window.cerrarAyudaFonetica = function () {
            console.log("cerrarAyudaFonetica called");
            document.getElementById('pronunciation-popover').classList.remove('visible');
        };

        // Funci贸n dedicada para la lista del historial
        window.playPronunciationTip = async function (textToPlay) {
            if (!textToPlay) return;

            try {
                // Feedback visual simple (opcional, global o toast)
                console.log("Reproduciendo:", textToPlay);

                const res = await fetch('/api/tts_word/', {
                    method: 'POST',
                    body: JSON.stringify({ text: textToPlay, lang: 'en-US' }), // Siempre pronunciaci贸n en ingl茅s para practicar
                    headers: { 'X-CSRFToken': getCookie('csrftoken') }
                });
                const data = await res.json();

                if (data.audio_base64) {
                    const audio = new Audio("data:audio/mp3;base64," + data.audio_base64);
                    audio.play();
                }
            } catch (e) {
                console.error("Error TTS History:", e);
            }
        };

        window.reproducirPalabra = async function () {
            if (!phraseToPlay) {
                console.warn("reproducirPalabra: No phrase to play");
                return;
            }

            const btn = document.getElementById('play-pronunciation-btn');
            const originalContent = btn.innerHTML;
            btn.innerHTML = '<span class="material-icons spinning">sync</span> Cargando...';
            btn.disabled = true;

            try {
                const res = await fetch('/api/tts_word/', {
                    method: 'POST',
                    body: JSON.stringify({ text: phraseToPlay, lang: 'en-US' }),
                    headers: { 'X-CSRFToken': getCookie('csrftoken') }
                });
                const data = await res.json();

                if (data.audio_base64) {
                    const audio = new Audio("data:audio/mp3;base64," + data.audio_base64);
                    audio.play();
                }
            } catch (e) {
                console.error("Error TTS:", e);
            } finally {
                btn.innerHTML = originalContent;
                btn.disabled = false;
            }
        };

        // --- GLOBAL EVENT DELEGATION (Robust Fix) ---
        document.addEventListener('click', function (e) {
            // 1. Ayuda Fon茅tica (Pop-up)
            const btnHelp = e.target.closest('.pronunciation-help-btn');
            if (btnHelp) {
                const text = btnHelp.dataset.text;
                if (text) window.mostrarAyudaFonetica(text);
                e.preventDefault();
                e.stopPropagation();
                return;
            }

            // 2. Reproducir Audio del Historial
            const btnPlay = e.target.closest('.play-tip-btn');
            if (btnPlay) {
                const text = btnPlay.dataset.text;
                if (text) window.playPronunciationTip(text);
                e.preventDefault();
                e.stopPropagation();
                return;
            }
        }, true);

        async function deleteChat(event, chatId) {
            // 1. Evitar que el clic se propague al div padre (que carga el chat)
            event.stopPropagation();

            // 2. Confirmaci贸n
            if (!confirm("驴Est谩s seguro de que quieres eliminar este chat? No se puede deshacer.")) {
                return;
            }

            try {
                // 3. Petici贸n al Backend
                const response = await fetch(`/chat/delete/${chatId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                });

                if (response.ok) {
                    // 4. Si se borr贸 bien, lo quitamos visualmente con una animaci贸n
                    const item = document.getElementById(`chat-item-${chatId}`);
                    item.style.opacity = '0';
                    setTimeout(() => item.remove(), 300); // Esperar a que desvanezca

                    // Si est谩bamos viendo ese chat, limpiar la pantalla
                    if (currentConversationId === chatId) {
                        messagesBox.innerHTML = '';
                        currentConversationId = null;
                        resetOrb();
                        // Opcional: mostrar mensaje de bienvenida
                        liveCaption.innerText = "Haz clic en el orbe para hablar...";
                    }
                } else {
                    alert("Error al eliminar el chat.");
                }
            } catch (error) {
                console.error("Error:", error);
            }
        }

        const tourSteps = [
            {
                elementId: 'magic-orb',
                title: 'El Orbe M谩gico',
                desc: 'Este es el coraz贸n de Naza. Haz clic aqu铆 para empezar a hablar. El orbe cambiar谩 de color cuando te est茅 escuchando o respondiendo.'
            },
            {
                elementId: 'gamification-bar',
                title: 'Tu Progreso',
                desc: 'Aqu铆 ver谩s tu Nivel, Experiencia (XP) y Racha de d铆as. 隆Haz clic en la barra para ver el Ranking Global y tus estad铆sticas detalladas!'
            },
            {
                // OJO: Aseg煤rate de que el div del selector de escenario tenga ID "scenario-selector-btn"
                // Si no lo tiene, agr茅galo en el HTML del paso anterior: <div class="scenario-selector" id="scenario-selector-btn"...
                elementId: 'scenario-selector-btn',
                title: 'Modo de Pr谩ctica',
                desc: '驴No sabes de qu茅 hablar? Elige un "Rol" aqu铆 (como Cafeter铆a o Entrevista) y Naza actuar谩 ese personaje.'
            },
            {
                elementId: 'user-menu-trigger', // El footer del sidebar
                title: 'Tu Perfil y Configuraci贸n',
                desc: 'Aqu铆 puedes cambiar la voz del bot, ver tu historial de errores completo, descargar reportes PDF o volver a ver este tutorial.'
            }
        ];

        let currentStepIndex = 0;

        function startTutorial() {
            // Cerrar men煤s si est谩n abiertos
            document.getElementById('user-menu-popup').classList.remove('visible');

            currentStepIndex = 0;
            document.getElementById('tutorial-overlay').classList.add('active');
            showStep(currentStepIndex);
        }

        function showStep(index) {
            const step = tourSteps[index];
            const target = document.getElementById(step.elementId);
            const card = document.getElementById('tutorial-card');

            // 1. Quitar resaltado anterior
            document.querySelectorAll('.tutorial-highlight').forEach(el => el.classList.remove('tutorial-highlight'));
            // Clean sidebar elevation
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) sidebar.classList.remove('sidebar-elevated');

            if (!target) {
                console.error("Elemento no encontrado:", step.elementId);
                // Si falla un paso, intentamos el siguiente en lugar de abortar
                currentStepIndex++;
                if (currentStepIndex < tourSteps.length) {
                    showStep(currentStepIndex);
                } else {
                    endTutorial();
                }
                return;
            }

            // 1.5. FORZAR VISIBILIDAD SI EST OCULTO
            // Si el estilo display es none, lo mostramos temporalmente para el tutorial
            const style = window.getComputedStyle(target);
            if (style.display === 'none') {
                target.style.display = 'flex'; // Asumimos flex para la barra, block para otros
                // Marcamos para ocultar luego si queremos ser puristas, 
                // pero dejarlo visible es mejor UX para que vea la feature.
            }

            // 2. Resaltar nuevo objetivo
            target.classList.add('tutorial-highlight');
            target.scrollIntoView({ behavior: 'smooth', block: 'center' }); // Asegurar que se ve

            // Elevate sidebar if needed (Fix for z-index/stacking context)
            if (target.closest('.sidebar')) {
                const sidebar = document.querySelector('.sidebar');
                if (sidebar) sidebar.classList.add('sidebar-elevated');
            }

            // 3. Llenar info
            document.getElementById('tut-title').innerText = step.title;
            document.getElementById('tut-desc').innerText = step.desc;
            document.getElementById('tut-step').innerText = `${index + 1}/${tourSteps.length}`;

            // 4. Posicionar la tarjeta cerca del elemento
            // Peque帽o delay para asegurar que el renderizado se actualiz贸 si estaba oculto
            setTimeout(() => {
                const rect = target.getBoundingClientRect();
                const cardWidth = 300;
                const cardHeight = 200;

                // L贸gica de posicionamiento mejorada
                let top = rect.bottom + 15; // Por defecto abajo
                let left = rect.left + (rect.width / 2) - (cardWidth / 2); // Centrado horizontal

                // Si se sale por abajo, poner arriba
                if (top + cardHeight > window.innerHeight) {
                    top = rect.top - cardHeight - 15;
                }

                // Si se sale por la izquierda o derecha, ajustar
                if (left < 10) left = 10;
                if (left + cardWidth > window.innerWidth) {
                    left = window.innerWidth - cardWidth - 10;
                }

                card.style.top = `${top}px`;
                card.style.left = `${left}px`;
                card.style.display = 'block';
            }, 100);
        }

        function nextStep() {
            currentStepIndex++;
            if (currentStepIndex < tourSteps.length) {
                showStep(currentStepIndex);
            } else {
                endTutorial();
                // Marcar que ya lo vio (opcional para el futuro)
                localStorage.setItem('tutorial_seen', 'true');
            }
        }

        function endTutorial() {
            document.getElementById('tutorial-overlay').classList.remove('active');
            document.getElementById('tutorial-card').style.display = 'none';
            document.querySelectorAll('.tutorial-highlight').forEach(el => el.classList.remove('tutorial-highlight'));
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) sidebar.classList.remove('sidebar-elevated');
        }

        // AUTO-INICIO (Opcional): Si es la primera vez que entra en este navegador
        document.addEventListener('DOMContentLoaded', () => {
            if (!localStorage.getItem('tutorial_seen')) {
                // Esperar un poco a que cargue todo visualmente
                setTimeout(startTutorial, 1000);
            }
        });

    </script>

    <!-- UI COMPONENTS (Moved inside body) -->
    <div id="system-alert-bar"
        style="display: none; background-color: #BB86FC; color: black; padding: 10px; text-align: center; font-weight: bold; position: fixed; top: 0; left: 0; width: 100%; z-index: 3000; box-shadow: 0 2px 10px rgba(0,0,0,0.3);">
        <span class="material-icons" style="vertical-align: middle; font-size: 1.2rem; margin-right: 5px;">info</span>
        <span id="system-alert-text">Mensaje del sistema...</span>
        <button onclick="document.getElementById('system-alert-bar').style.display='none'"
            style="background:none; border:none; float:right; cursor:pointer; font-weight:bold; font-size:1.2rem;">&times;</button>
    </div>

    <!-- Coach Panel -->
    <div id="coach-panel" class="coach-panel">
        <div class="coach-card">
            <div class="coach-title">
                <span class="material-icons">school</span>
                Tip de Aprendizaje
            </div>
            <div id="coach-original" style="font-style:italic; font-size:0.9rem; color:#ccc; margin-bottom:5px;">
            </div>
            <div id="coach-correction" style="font-weight:bold; color:#fff; margin-bottom:5px;"></div>
            <div id="coach-explanation" style="font-size:0.85rem; color:#bbb;"></div>
        </div>
    </div>

    <!-- Popover de Pronunciaci贸n -->
    <div id="pronunciation-popover" class="pronunciation-popover">
        <button class="close-popover" onclick="window.cerrarAyudaFonetica()">&times;</button>
        <div class="popover-content">
            <h3><span class="material-icons" style="color:#FFEA00; vertical-align:middle;">lightbulb</span> Tip de
                Pronunciaci贸n</h3>
            <p id="popover-text">Cargando...</p>
            <button id="play-pronunciation-btn" class="play-btn" onclick="window.reproducirPalabra()">
                <span class="material-icons">volume_up</span> Escuchar
            </button>
        </div>
    </div>

    <!-- Modal de Confirmaci贸n de Eliminaci贸n -->
    <div id="delete-confirm-modal" class="delete-modal-overlay" onclick="if(event.target===this) hideDeleteModal()">
        <div class="delete-modal-card">
            <span class="material-icons modal-icon">delete_forever</span>
            <h3>驴Eliminar esta nota?</h3>
            <p>Esta acci贸n no se puede deshacer.</p>
            <div class="delete-modal-actions">
                <button class="btn-modal-cancel" onclick="hideDeleteModal()">Cancelar</button>
                <button class="btn-modal-delete" onclick="confirmDeleteNote()">Eliminar</button>
            </div>
        </div>
    </div>

    <script src="{% static 'js/transitions.js' %}"></script>
</body>


</html>